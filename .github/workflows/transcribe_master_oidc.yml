name: transcribe-fe master (OIDC)
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

# Required for OIDC authentication
permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    environment:
      name: transcribe-fe-master
    steps:
      # Configure AWS credentials using OIDC - no access keys needed!
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-central-1
          role-session-name: github-actions-deploy

      - uses: actions/checkout@v4
        id: checkout

      - uses: actions/setup-node@v4
        with:
          node-version: 20.9.0

      # Create .env file with Vite environment variables
      - name: Create .env file
        run: |
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" > .env
          echo "VITE_ENV=production" >> .env

      # Install dependencies and build the app
      - name: Build Vite App
        run: |
          npm install
          npm run build

      # Upload the static app files to S3 bucket
      - name: Deploy Static Files to S3
        id: deploy-project
        run: |
          cd dist
          aws s3 sync . s3://${{ secrets.BUCKET }} --cache-control "max-age=120000" --delete --exclude ".git/*" --exclude ".github/*" --exclude "README*" --exclude "*.md"

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ secrets.DISTRIBUTION_ID }} --paths "/*"
